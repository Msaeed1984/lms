<!-- license-template/home.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Licenses & Certificates Manager</title>
</head>
<body>

  {% include "license-template/header.html" %}

  <main class="page">
    <div class="container">

      <!-- Hero -->
      <section class="hero" id="dashboard" aria-label="Overview">
        <div>
          <h1 id="helloTitle">Welcome</h1>
          <p>
            Track certificates and licenses, attach evidence images, and receive smart expiry reminders  .
            <span class="muted">Designed with EMSTEEL style (Blue/Green).</span>
          </p>
        </div>

        <div class="meta">
          <span class="pill" id="userPill">
            User: {{ request.user.username|default:"Guest" }}
          </span>
          <span class="pill" id="todayPill">—</span>
          <button class="btn success" type="button" onclick="window.location.href='#records'">View Records</button>
        </div>
      </section>

      <div style="height:14px"></div>

      <!-- KPI Cards -->
      <section class="grid cols-4" aria-label="KPI Cards">
        <div class="card">
          <div class="hd">
            <b>Total Records</b>
            <small class="muted">All certificates/licenses</small>
          </div>
          <div class="bd">
            <div class="stat">
              <div>
                <div class="num">{{ total_count|default:"0" }}</div>
                <div class="lbl">Registered items</div>
              </div>
              <span class="badge info">Live</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <b>Expiring Soon</b>
            <small class="muted">Next 30 days</small>
          </div>
          <div class="bd">
            <div class="stat">
              <div>
                <div class="num">{{ expiring_soon_count|default:"0" }}</div>
                <div class="lbl">Need action</div>
              </div>
              <span class="badge warn">Warning</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <b>Expired</b>
            <small class="muted">Past due</small>
          </div>
          <div class="bd">
            <div class="stat">
              <div>
                <div class="num">{{ expired_count|default:"0" }}</div>
                <div class="lbl">Immediate follow-up</div>
              </div>
              <span class="badge bad">Critical</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <b>Valid</b>
            <small class="muted">Not expired</small>
          </div>
          <div class="bd">
            <div class="stat">
              <div>
                <div class="num">{{ valid_count|default:"0" }}</div>
                <div class="lbl">In compliance</div>
              </div>
              <span class="badge ok">OK</span>
            </div>
          </div>
        </div>
      </section>

      <div style="height:14px"></div>

      <!-- ✅ Smart Reminder + Tips removed بالكامل -->

      <!-- Records Table -->
      <section class="card" id="records" aria-label="Records Table">
        <div class="hd">
          <div>
            <b>Certificates & Licenses</b>
            <div class="muted" style="margin-top:2px; font-size:12px;">Preview images + status badges + expiry details</div>
          </div>
          <small class="muted">Showing: <span id="shownCount">—</span></small>
        </div>

        <div class="bd table-wrap">
          <table id="recordsTable" aria-label="Records">
            <thead>
              <tr>
                <th>Status</th>
                <th>Record ID</th>
                <th>Title</th>

                <!-- ✅ NEW: show Organization only for ADMIN -->
                {% if is_global_admin %}
                  <th>Organization</th>
                {% endif %}

                <th>Owner</th>
                <th>Expiry Date</th>
                <th>Days Left</th>
                <th>
                  Evidence
                  <span class="muted" style="font-size:11px; margin-left:6px;">(Preview)</span>
                </th>
              </tr>
            </thead>

            <tbody id="recordsBody">
              {% if org_missing %}
                <tr>
                  <td colspan="{% if is_global_admin %}8{% else %}7{% endif %}" class="muted">
                    No Organization assigned to your account. Contact admin.
                  </td>
                </tr>
              {% else %}
                {% for r in records %}
                  <tr data-status="{{ r.status_ui }}">
                    <td>
                      <span class="status {% if r.status_ui == 'expired' %}bad{% elif r.status_ui == 'expiring' %}warn{% else %}ok{% endif %}">
                        <span class="s-dot"></span>
                        <span class="badge {% if r.status_ui == 'expired' %}bad{% elif r.status_ui == 'expiring' %}warn{% else %}ok{% endif %}">
                          {% if r.status_ui == 'expired' %}Expired{% elif r.status_ui == 'expiring' %}Expiring{% else %}Valid{% endif %}
                        </span>
                      </span>
                    </td>

                    <td><b>{{ r.id }}</b></td>
                    <td>{{ r.title }}</td>

                    <!-- ✅ NEW: org column only for ADMIN -->
                    {% if is_global_admin %}
                      <td class="muted">{{ r.org_name|default:"—" }}</td>
                    {% endif %}

                    <td class="muted">{{ r.owner_name }}</td>
                    <td>{{ r.expiry_date|date:"Y-m-d" }}</td>

                    <td>
                      {% if r.days_left < 0 %}
                        <span class="badge bad">Overdue</span>
                      {% elif r.days_left <= 30 %}
                        <span class="badge warn">{{ r.days_left }} days</span>
                      {% else %}
                        <span class="badge ok">{{ r.days_left }} days</span>
                      {% endif %}
                    </td>

                    <td>
                      {% if r.preview_url %}
                        <button class="btn" type="button"
                          onclick="LMS_UI.openPreview('{{ r.title|escapejs }} — #{{ r.id }}','{{ r.preview_url|escapejs }}')">
                          Preview
                        </button>
                      {% else %}
                        <span class="muted">—</span>
                      {% endif %}
                    </td>

                  </tr>
                {% empty %}
                  <!-- If no backend rows, keep your JS demo behavior -->
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>

      <div style="height:18px"></div>
    </div>
  </main>

  {% include "license-template/footer.html" %}

  <!-- ✅ Image Preview Popup (Nice) -->
  <div id="imgOverlay" style="
    position:fixed; inset:0; display:none; z-index:999;
    background: rgba(15,23,42,.55);
    backdrop-filter: blur(6px);
    padding:14px;
    align-items:center; justify-content:center;
  " role="dialog" aria-modal="true" aria-label="Image Preview">
    <div style="
      width:min(980px,100%);
      background:#fff;
      border:1px solid rgba(229,231,235,1);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 40px 90px rgba(15,23,42,.30);
    ">
      <div style="
        padding:12px 14px;
        background: linear-gradient(90deg, rgba(0,119,200,.10), rgba(91,197,0,.10));
        border-bottom:1px solid rgba(238,242,247,1);
        display:flex; align-items:center; justify-content:space-between; gap:10px;
      ">
        <div id="imgTitle" style="
          font-size:13.5px; font-weight:700; color:#0f172a;
          white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        ">Preview</div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <a id="imgOpen" href="#" target="_blank" rel="noopener" class="btn"
             style="padding:8px 10px; font-size:12px; display:none; text-decoration:none;">
            Open
          </a>
          <button class="btn" type="button" style="padding:8px 10px; font-size:12px;" onclick="LMS_UI.closePreview()">
            Close
          </button>
        </div>
      </div>

      <div style="background:#f8fafc; padding:12px; display:flex; justify-content:center; align-items:center;">
        <img id="imgView" alt="Evidence Preview" src=""
             style="width:100%; max-height:72vh; object-fit:contain; border-radius:14px; border:1px solid #E5E7EB; background:#fff;">
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities + Preview Popup =====
    const LMS_UI = window.LMS_UI || {};
    LMS_UI.openPreview = function(title, imgUrl){
      const overlay = document.getElementById("imgOverlay");
      const img = document.getElementById("imgView");
      const t = document.getElementById("imgTitle");
      const open = document.getElementById("imgOpen");

      if(!overlay || !img || !t) return;
      if(!imgUrl) return;

      t.textContent = title || "Preview";
      img.src = imgUrl;

      if(String(imgUrl).startsWith("data:image/")){
        open.style.display = "none";
        open.href = "#";
      }else{
        open.style.display = "inline-flex";
        open.href = imgUrl;
      }

      overlay.style.display = "flex";
      document.body.style.overflow = "hidden";
    };

    LMS_UI.closePreview = function(){
      const overlay = document.getElementById("imgOverlay");
      const img = document.getElementById("imgView");
      if(overlay) overlay.style.display = "none";
      if(img) img.src = "";
      document.body.style.overflow = "";
    };

    (function(){
      const overlay = document.getElementById("imgOverlay");
      if(!overlay) return;
      overlay.addEventListener("click", function(e){
        if(e.target === overlay) LMS_UI.closePreview();
      });
      document.addEventListener("keydown", function(e){
        if(e.key === "Escape" && overlay.style.display === "flex"){
          LMS_UI.closePreview();
        }
      });
    })();

    // ===== Page JS =====
    (function(){
      const hello = document.getElementById("helloTitle");
      const todayPill = document.getElementById("todayPill");

      const now = new Date();
      const hr = now.getHours();
      const greet = hr < 12 ? "Good morning" : (hr < 18 ? "Good afternoon" : "Good evening");
      if (hello) hello.textContent = greet + " — License & Certificates Dashboard";

      if (todayPill){
        todayPill.textContent = now.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"short", day:"2-digit" });
      }
    })();

    // Filter/search
    window.LMS_FILTER = window.LMS_FILTER || {
      apply: function(type){
        const rows = Array.from(document.querySelectorAll("#recordsBody tr"));
        rows.forEach(r => {
          const st = (r.getAttribute("data-status") || "all").toLowerCase();
          const show =
            type === "all" ||
            (type === "valid" && st === "valid") ||
            (type === "expiring" && st === "expiring") ||
            (type === "expired" && st === "expired");
          r.style.display = show ? "" : "none";
        });
        window.LMS_FILTER.updateShown();
      },
      updateShown: function(){
        const rows = Array.from(document.querySelectorAll("#recordsBody tr"));
        const visible = rows.filter(r => r.style.display !== "none").length;
        const el = document.getElementById("shownCount");
        if (el) el.textContent = String(visible);
      }
    };

    (function(){
      const input = document.getElementById("globalSearch");
      if (!input) return;

      input.addEventListener("input", function(){
        const q = String(input.value || "").trim().toLowerCase();
        const rows = Array.from(document.querySelectorAll("#recordsBody tr"));

        rows.forEach(r => {
          const text = (r.innerText || "").toLowerCase();
          r.style.display = (!q || text.includes(q)) ? "" : "none";
        });

        window.LMS_FILTER.updateShown();
      });

      window.LMS_FILTER.updateShown();
    })();
  </script>

</body>
</html>
